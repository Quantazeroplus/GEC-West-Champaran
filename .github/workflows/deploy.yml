name: Full Secure & Obfuscate Deploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install Tools
        run: |
          npm install -g javascript-obfuscator
          npm install -g html-minifier
          npm install -g clean-css-cli

      - name: Inject Secrets
        run: |
          sed -i 's|PROD_URL_PLACEHOLDER|${{ secrets.GOOGLE_SCRIPT_URL }}|g' script.js
          sed -i 's|PROD_KEY_PLACEHOLDER|${{ secrets.MY_PERMANENT_KEY }}|g' script.js

      - name: Obfuscate & Minify
        run: |
          mkdir -p dist

          # 1. Obfuscate script.js (Maximum Security)
          javascript-obfuscator script.js --output dist/script.js --compact true --self-defending true --string-array true --string-array-encoding 'base64' --string-array-threshold 1

          # 2. Minify index.html (Removes spaces/comments to hide structure)
          html-minifier --collapse-whitespace --remove-comments --remove-optional-tags --remove-redundant-attributes --remove-script-type-attributes --remove-tag-whitespace --use-short-doctype index.html -o dist/index.html

          # 3. Minify style.css (Turns it into a single unreadable line)
          cleancss -o dist/style.css style.css

          # 4. Copy assets
          [ -d "image" ] && cp -r image dist/ || echo "No images"
          [ -f "manifest.json" ] && cp manifest.json dist/ || echo "No manifest"
          [ -f "sw.js" ] && cp sw.js dist/ || echo "No sw.js"

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages
