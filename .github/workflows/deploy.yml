name: Full Secure & Obfuscate Deploy

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Obfuscator
        run: npm install -g javascript-obfuscator

      - name: Inject Secret URL into script.js
        run: |
          sed -i "s|PROD_URL_PLACEHOLDER|${{ secrets.GOOGLE_SCRIPT_URL }}|g" script.js

      - name: Obfuscate & Build
        run: |
          mkdir -p dist
          
          # 1. Scramble script.js (High Security)
          javascript-obfuscator script.js --output dist/script.js --compact true --self-defending true --string-array true --string-array-encoding 'base64' --string-array-threshold 1
          
          # 2. Scramble index.html (This scrambles any remaining inline JS and minifies HTML)
          javascript-obfuscator index.html --output dist/index.html --compact true --self-defending true
          
          # 3. Copy other assets
          if [ -d "image" ]; then cp -r image dist/; fi
          if [ -f "manifest.json" ]; then cp manifest.json dist/; fi
          if [ -f "style.css" ]; then cp style.css dist/; fi

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}