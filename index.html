<!DOCTYPE html>
<html lang="en" class="dark scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GEC WC | Smart Attendance</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="image/logo.png">
    <link rel="icon" type="image/png" href="image/logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins', 'sans-serif'] },
                    colors: {
                        brandBlue: '#2563eb',
                        brandGreen: '#10b981',
                        brandRed: '#ef4444',
                        amoled: '#000000',
                        darkSurface: '#121212',
                        darkBorder: '#262626'
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(15px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        .input-group {
            position: relative;
            margin-bottom: 1.25rem;
        }

        .input-field {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            background: #ffffff;
            outline: none;
            transition: all 0.25s ease;
            font-size: 1rem;
            color: #18181b;
            z-index: 10;
            position: relative;
        }

        .dark .input-field {
            background: #0a0a0a;
            border-color: #262626;
            color: #ffffff;
        }

        .input-field:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.15);
        }

        .input-label {
            position: absolute;
            top: 16px;
            left: 16px;
            pointer-events: none;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            z-index: 20;
        }

        .label-required {
            color: #ef4444;
        }

        .label-optional {
            color: #10b981;
        }

        .input-field:focus+.input-label,
        .input-field:not(:placeholder-shown)+.input-label {
            top: -10px;
            left: 12px;
            font-size: 0.75rem;
            background: #ffffff;
            padding: 0 8px;
            font-weight: 700;
        }

        .dark .input-field:focus+.input-label,
        .dark .input-field:not(:placeholder-shown)+.input-label {
            background: #121212;
        }

        .input-field:focus+.label-required {
            color: #ef4444 !important;
        }

        .input-field:focus+.label-optional {
            color: #10b981 !important;
        }

        #map {
            border-radius: 20px;
            height: 200px;
            width: 100%;
            border: 1px solid #e2e8f0;
        }

        .dark #map {
            filter: invert(100%) hue-rotate(180deg) brightness(105%) contrast(85%);
            border-color: #262626;
        }

        .dist-gauge {
            transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .premium-logo {
            filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.15));
            transition: transform 0.3s ease;
            max-width: none;
            z-index: 60;
        }

        @media (max-width: 640px) {
            .input-field {
                font-size: 16px;
            }

            #map {
                height: 160px;
            }

            .premium-logo {
                width: 140px !important;
                height: 140px !important;
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-8px);
            }

            75% {
                transform: translateX(8px);
            }
        }

        .animate-shake {
            animation: shake 0.2s ease-in-out 0s 2;
            border-color: #ef4444 !important;
        }
    </style>
</head>

<body
    class="bg-slate-50 dark:bg-amoled text-slate-900 dark:text-zinc-100 antialiased min-h-screen selection:bg-brandBlue/30 transition-colors duration-300">

    <div id="noticeGrid" class="hidden fixed top-20 left-0 w-full px-4 py-4 z-[100] pointer-events-none">
        <div id="gridItems" class="max-w-md mx-auto pointer-events-auto">
        </div>
    </div>


    <div id="notification"
        class="fixed top-4 left-1/2 -translate-x-1/2 z-[3000] opacity-0 pointer-events-none transform -translate-y-2 transition-all duration-300 w-[90%] max-w-sm">
        <div id="notifyContent"
            class="px-5 py-3 rounded-2xl shadow-2xl font-bold text-sm text-center border backdrop-blur-xl"></div>
    </div>

    <nav
        class="bg-white/90 dark:bg-black/80 backdrop-blur-lg fixed top-0 w-full z-50 border-b border-slate-200 dark:border-zinc-800/50 h-16 md:h-20">
        <div class="container mx-auto px-4 h-full flex justify-between items-center relative">
            <div class="flex items-center h-full">
                <div class="relative flex items-center justify-center w-16 md:w-24 h-full">
                    <img src="image/logo.png" alt="GEC WC Logo"
                        class="premium-logo absolute w-24 h-24 md:w-48 md:h-48 object-contain"
                        onerror="this.src='https://via.placeholder.com/200?text=GEC'">
                </div>
                <div class="flex flex-col ml-3 md:ml-6">
                    <span
                        class="text-xl md:text-2xl font-black tracking-tight uppercase leading-none text-slate-900 dark:text-white">GEC<span
                            class="text-brandBlue">WC</span></span>
                    <span class="text-[8px] md:text-[10px] font-bold text-slate-400 tracking-[0.2em] uppercase">CSE
                        Cyber Security</span>
                </div>
            </div>

            <div class="flex items-center gap-2 md:gap-3">
                <div onclick="showGPSStatus()"
                    class="flex items-center gap-2 bg-slate-100 dark:bg-zinc-900 px-2 md:px-3 py-1.5 rounded-full border border-slate-200 dark:border-zinc-800 cursor-pointer active:scale-95 transition-transform">
                    <div class="relative flex h-2.5 w-2.5">
                        <span id="gps-ping"
                            class="hidden absolute inline-flex h-full w-full rounded-full bg-brandGreen opacity-75 animate-ping"></span>
                        <span id="gps-dot" class="relative inline-flex rounded-full h-2.5 w-2.5 bg-slate-400"></span>
                    </div>
                    <span id="gps-text"
                        class="hidden md:block text-[9px] font-black uppercase tracking-widest text-zinc-500">GPS
                        IDLE</span>
                </div>

                <div id="qr-status"
                    class="hidden flex items-center gap-2 bg-blue-50 dark:bg-blue-900/20 px-3 py-1.5 rounded-full border border-blue-100 dark:border-blue-800">
                    <div class="relative flex h-2 w-2">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
                    </div>
                    <span class="text-[9px] font-black text-blue-600 dark:text-blue-400 uppercase tracking-widest">QR
                        VERIFIED</span>
                </div>

                <button onclick="openHistory(event)"
                    class="relative w-10 h-10 flex items-center justify-center rounded-xl bg-slate-100 dark:bg-zinc-900 text-slate-600 dark:text-blue-400 border border-slate-200 dark:border-zinc-800 transition-all">
                    <i class="fas fa-bell"></i>
                    <span id="notif-badge"
                        class="hidden absolute top-2 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white dark:border-black"></span>
                </button>

                <button onclick="toggleTheme()"
                    class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-100 dark:bg-zinc-900 text-slate-600 dark:text-yellow-400 border border-slate-200 dark:border-zinc-800 transition-all">
                    <i id="theme-icon" class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </nav>


    <div id="historyModal"
        class="hidden fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-darkSurface w-full max-w-md rounded-[2.5rem] border border-slate-200 dark:border-darkBorder shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-slate-100 dark:border-zinc-800 flex justify-between items-center">
                <h3 class="font-black text-xl tracking-tight dark:text-white">Notice Center</h3>
                <button onclick="closeHistory()" class="text-slate-400 hover:text-brandRed transition-colors">
                    <i class="fas fa-times-circle text-2xl"></i>
                </button>
            </div>
            <div id="historyList" class="max-h-[60vh] overflow-y-auto p-4 space-y-3"></div>
        </div>
    </div>

    <main class="container mx-auto max-w-5xl pt-32 md:pt-48 pb-10 px-4 md:px-6">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8 items-start">

            <div class="lg:col-span-5 space-y-6">
                <div
                    class="bg-white dark:bg-darkSurface p-5 md:p-6 rounded-[2.5rem] border border-slate-200 dark:border-darkBorder shadow-lg dark:shadow-[0_0_50px_rgba(0,0,0,0.5)] animate-slide-up">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-400 dark:text-zinc-500 text-sm uppercase tracking-widest">
                            <i class="fas fa-satellite-dish mr-2 text-brandBlue"></i> Proximity
                        </h3>
                        <span id="range-tag"
                            class="text-[10px] font-bold px-2 py-0.5 rounded-md bg-brandRed/10 text-brandRed border border-brandRed/20">OUT
                            OF RANGE</span>
                    </div>

                    <div id="proximity-card"
                        class="relative bg-slate-50 dark:bg-black rounded-3xl p-6 text-center overflow-hidden mb-5 border border-slate-200 dark:border-zinc-800 transition-colors duration-500">
                        <p class="text-slate-500 dark:text-zinc-500 text-[10px] uppercase font-bold mb-1">Distance to
                            Class</p>
                        <div id="liveDist"
                            class="text-6xl font-black text-slate-900 dark:text-white mb-3 tracking-tighter">--<span
                                class="text-xl font-medium text-slate-400 dark:text-zinc-600 ml-1">m</span></div>

                        <div
                            class="w-full bg-slate-200 dark:bg-zinc-900 h-2.5 rounded-full overflow-hidden border border-slate-100 dark:border-zinc-800">
                            <div id="distBar" class="dist-gauge h-full bg-brandRed w-0"></div>
                        </div>
                    </div>

                    <div id="map"></div>
                </div>
            </div>

            <div class="lg:col-span-7">
                <div
                    class="bg-white dark:bg-darkSurface p-6 md:p-10 rounded-[2.5rem] border border-slate-200 dark:border-darkBorder shadow-lg dark:shadow-[0_0_50px_rgba(0,0,0,0.5)] relative overflow-hidden h-full">

                    <div
                        class="absolute -bottom-10 -right-10 opacity-[0.04] dark:opacity-[0.08] pointer-events-none transform rotate-12 z-0">
                        <i class="fas fa-fingerprint text-[20rem]"></i>
                    </div>

                    <div class="absolute top-0 right-0 p-6 z-20">
                        <div
                            class="bg-brandBlue/10 dark:bg-brandBlue/20 border border-brandBlue/30 text-brandBlue px-2 py-1 rounded-full font-black text-xs tracking-widest uppercase">
                            Room no:60
                        </div>
                    </div>

                    <div class="mb-8 relative z-10">
                        <h2 class="text-3xl font-black mb-0 text-slate-900 dark:text-white">Attendance</h2>
                        <!-- Added CSE Cyber Security Label -->
                        <div class="text-[10px] font-bold text-brandBlue uppercase tracking-[0.2em] mb-2">CSE Cyber
                            Security</div>
                        <p class="text-slate-500 dark:text-zinc-400 text-sm">Register your presence for class.</p>
                    </div>

                    <form id="entryForm" class="hidden animate-slide-up space-y-2 relative z-10">
                        <div class="input-group">
                            <input type="text" id="roll" name="roll" class="input-field peer" placeholder=" " required
                                onfocus="primeHaptics()">
                            <label for="roll" class="input-label label-required"><i
                                    class="fas fa-id-badge mr-2 opacity-50"></i>Roll Number *</label>
                        </div>

                        <div id="form-content" class="space-y-4">
                            <div class="input-group">
                                <input type="text" id="name" name="name" class="input-field peer" placeholder=" "
                                    required onfocus="primeHaptics()">
                                <label for="name" class="input-label label-required">Full Name *</label>
                            </div>

                            <div class="input-group">
                                <input type="text" id="reg" name="reg" class="input-field peer" placeholder=" " required
                                    onfocus="primeHaptics()">
                                <label for="reg" class="input-label label-required">Registration No. *</label>
                            </div>

                            <div class="grid grid-cols-1 gap-4">
                                <div class="input-group">
                                    <input type="email" id="email" name="email" class="input-field peer" placeholder=" "
                                        required onfocus="primeHaptics()">
                                    <label for="email" class="input-label label-required">Email Address *</label>
                                </div>

                                <div class="input-group">
                                    <input type="tel" id="mobile" name="mobile" class="input-field peer" placeholder=" "
                                        onfocus="primeHaptics()">
                                    <label for="mobile" class="input-label label-optional">Mobile (Optional)</label>
                                </div>
                            </div>

                            <div class="input-group">
                                <textarea id="note" name="note" class="input-field h-24 peer py-4 resize-none"
                                    placeholder=" " onfocus="primeHaptics()"></textarea>
                                <label for="note" class="input-label label-optional">Special Note (Optional)</label>
                            </div>
                        </div>
                        <div
                            class="bg-slate-50 dark:bg-zinc-900/50 p-4 rounded-3xl border border-slate-100 dark:border-zinc-800 mb-6">
                            <div class="flex items-center justify-between mb-3">
                                <span class="text-[10px] font-black uppercase tracking-widest text-brandBlue">Security
                                    PIN</span>
                                <span id="pin-timer" class="text-[10px] font-bold text-slate-400">Refreshes in:
                                    --:--</span>
                            </div>

                            <div class="flex items-center gap-3">
                                <div id="pinDisplay"
                                    class="bg-white dark:bg-black px-4 py-3 rounded-2xl font-black text-2xl text-brandBlue border-2 border-dashed border-brandBlue/30 select-none animate-pulse">
                                    ----
                                </div>

                                <div class="flex-grow relative">
                                    <input type="text" id="userPinInput" maxlength="4"
                                        class="input-field !mb-0 text-center font-bold tracking-[0.5em]"
                                        placeholder="TYPE PIN" autocomplete="off">
                                </div>
                            </div>
                            <p class="text-[9px] text-slate-400 mt-2 text-center font-medium uppercase">Enter the code
                                shown on the left to verify presence</p>
                        </div>



                        <button type="submit" id="submitBtn" disabled
                            class="w-full bg-brandBlue opacity-50 cursor-not-allowed text-white py-5 rounded-2xl font-black text-lg shadow-lg transition-all flex items-center justify-center gap-3">
                            <span>MARK ATTENDANCE</span>
                            <i class="fas fa-lock" id="btn-lock-icon"></i>
                        </button>
                    </form>

                    <div id="lockMessage" class="py-16 text-center space-y-6 relative z-10">
                        <div
                            class="w-24 h-24 bg-slate-50 dark:bg-zinc-900 rounded-full flex items-center justify-center mx-auto border border-slate-200 dark:border-zinc-800 shadow-inner">
                            <i class="fas fa-location-dot text-brandRed text-4xl"></i>
                        </div>
                        <div>
                            <p class="text-brandRed font-black text-xl uppercase tracking-tighter">Access Denied</p>
                            <p class="text-slate-500 dark:text-zinc-400 text-sm mt-1">Please move within 15m of Room 60
                                desk.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="lg:col-span-12 mt-12 mb-10 space-y-4">

            <div id="ongoing-section" class="hidden animate-slide-up">
                <div
                    class="relative overflow-hidden bg-white dark:bg-zinc-950 p-5 md:p-6 rounded-[2.5rem] border border-slate-200 dark:border-white/10 shadow-2xl">
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-brandBlue/10 blur-[50px] rounded-full"></div>

                    <div class="relative z-10 flex flex-col md:flex-row items-center gap-6">
                        <div class="relative flex-shrink-0">
                            <div
                                class="w-24 h-24 rounded-[2rem] overflow-hidden border-2 border-white dark:border-zinc-800 shadow-xl bg-white">
                                <img id="active-teacher-img" src="image/logo.png" class="w-full h-full object-cover">
                            </div>
                            <div id="active-badge"
                                class="absolute -bottom-1 -right-1 text-white text-[8px] font-black px-3 py-1 rounded-xl border-2 border-white dark:border-zinc-950 shadow-lg uppercase">
                                --</div>
                        </div>

                        <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                            <div>
                                <div id="status-tag-container"
                                    class="inline-flex items-center gap-2 px-3 py-1 rounded-full mb-2 border">
                                    <span class="relative flex h-2 w-2">
                                        <span id="ping-ring"
                                            class="absolute inline-flex h-full w-full rounded-full opacity-75"></span>
                                        <span id="ping-dot" class="relative inline-flex rounded-full h-2 w-2"></span>
                                    </span>
                                    <span class="text-[9px] font-black uppercase tracking-widest"
                                        id="status-text">--</span>
                                </div>
                                <h2 id="active-subject"
                                    class="text-2xl font-black text-slate-900 dark:text-white leading-tight truncate">
                                    ---</h2>
                                <div class="flex items-center gap-3 mt-1">
                                    <p id="active-faculty"
                                        class="text-slate-500 dark:text-zinc-400 font-bold text-[9px] uppercase tracking-widest truncate">
                                        ---</p>
                                    <span class="w-1 h-1 rounded-full bg-slate-300"></span>
                                    <p class="text-brandBlue font-black text-[9px] uppercase tracking-widest">Room 60
                                    </p>
                                </div>
                            </div>

                            <div
                                class="bg-slate-50 dark:bg-white/[0.03] p-4 rounded-3xl border border-slate-100 dark:border-white/5 flex flex-col justify-center">
                                <div class="flex justify-between items-end mb-1">
                                    <p class="text-[8px] font-black text-slate-400 uppercase">Session Timer</p>
                                    <div id="active-countdown"
                                        class="text-sm font-black text-slate-900 dark:text-white tabular-nums tracking-tighter">
                                        --:--</div>
                                </div>
                                <div class="w-full h-1.5 bg-slate-200 dark:bg-zinc-800 rounded-full overflow-hidden">
                                    <div id="active-class-progress"
                                        class="h-full rounded-full transition-all duration-1000" style="width: 0%">
                                    </div>
                                </div>
                                <div class="flex justify-between mt-1 text-[7px] font-black text-slate-400 uppercase">
                                    <span id="active-start-label">--:--</span>
                                    <span id="active-end-label">--:--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="timeline-section" class="lg:col-span-12 hidden animate-slide-up mb-12">
                <div
                    class="bg-white dark:bg-zinc-950 p-6 pr-0 md:p-8 md:pr-0 rounded-[2.5rem] border-2 border-slate-200 dark:border-white/10 shadow-xl relative w-full overflow-hidden">

                    <div class="flex items-center justify-between mb-8 px-2 pr-6">
                        <div>
                            <h3 class="font-black text-xl text-slate-900 dark:text-white tracking-tight">Today's Journey
                            </h3>
                            <p class="text-[9px] text-brandBlue font-black uppercase tracking-[0.2em]">Live Tracking
                                Enabled</p>
                        </div>
                        <div id="day-progress-text"
                            class="px-4 py-1.5 rounded-xl font-black text-[9px] uppercase tracking-widest border-2">--
                        </div>
                    </div>

                    <div class="relative px-2">
                        <div
                            class="absolute left-[24px] top-4 bottom-4 w-[3px] bg-slate-100 dark:bg-zinc-900 rounded-full">
                        </div>
                        <div id="timeline-progress-bar"
                            class="absolute left-[24px] top-4 w-[3px] bg-gradient-to-b from-brandBlue to-brandGreen transition-all duration-1000 z-[10] rounded-full shadow-[0_0_10px_rgba(37,99,235,0.3)]">
                        </div>

                        <div id="roadmap-list"
                            class="relative space-y-4 max-h-[500px] overflow-y-auto pr-6 pl-0  custom-scrollbar scroll-smooth">
                        </div>
                    </div>
                </div>
            </div>

            <style>
                /* Absolute Right Scrollbar Styling */
                .custom-scrollbar::-webkit-scrollbar {
                    width: 5px;
                    /* Very thin */
                }

                .custom-scrollbar::-webkit-scrollbar-track {
                    background: transparent;
                    /* Makes it look like it's floating */
                    margin-top: 10px;
                    /* Optional: padding from top border */
                    margin-bottom: 10px;
                    /* Optional: padding from bottom border */
                }

                .custom-scrollbar::-webkit-scrollbar-thumb {
                    background: #2563eb;
                    /* Brand Blue color */
                    border-radius: 20px;
                }

                .dark .custom-scrollbar::-webkit-scrollbar-thumb {
                    background: #590228b5;
                    /* Zinc color for dark mode */
                }

                /* Keep content from overlapping the absolute scrollbar */
                #roadmap-list>div {
                    margin-right: 4px;
                }
            </style>
        </div>

        <div
            class="bg-white dark:bg-darkSurface p-6 rounded-[2.5rem] border border-slate-200 dark:border-darkBorder shadow-lg space-y-4">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-black text-xl tracking-tight"><i class="fas fa-history mr-2 text-brandBlue"></i>
                    Your Recent Logs</h3>
                <button onclick="clearMyHistory()"
                    class="text-[10px] font-bold text-slate-400 uppercase tracking-widest hover:text-brandRed transition-colors">Clear
                    History</button>
            </div>
            <div id="localLogsList" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <p id="noLogsMsg"
                    class="col-span-full text-center py-10 text-slate-400 italic text-sm border-2 border-dashed border-slate-100 dark:border-zinc-800 rounded-3xl">
                    No check-ins recorded on this device yet.</p>
            </div>
        </div>l
        </div>
    </main>

    <script>

        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyrwZsXdVRvz1kOmBu9WeVu7lwSbNaKJB8PgfvX1jCFEwgck-QMLgjoKJOUm1--0dr_CQ/exec";
        const CLASS_COORDS = { lat: 26.874445, lng: 84.510308 };
        const MAX_DIST = 350;
        let currentLockState = ""; 

        // --- SECURE SPATIAL FINGERPRINT ---
        let smoothedAlpha = null;
        const ROOM_60_ANGLE = 200;
        const ANGLE_TOLERANCE = 40;
        let floorVerified = false;

        async function checkPhysicalFloor() {
            const magDisplay = document.getElementById('debug-mag');
            const pingArea = document.getElementById('ping-area');
            const needle = document.getElementById('compass-needle');

            if (window.DeviceOrientationEvent) {
                // Removed {once: true} to allow smooth, normal compass behavior
                window.addEventListener('deviceorientationabsolute', (event) => {
                    if (event.alpha !== null) {

                        if (pingArea) pingArea.classList.add('hidden');

                        let liveAlpha = event.alpha;

                        // 2. DATA SMOOTHING
                        if (smoothedAlpha === null) {
                            smoothedAlpha = liveAlpha;
                        } else {
                            let diff = liveAlpha - smoothedAlpha;
                            if (diff > 180) diff -= 360;
                            if (diff < -180) diff += 360;

                            // ADAPTIVE SPEED: Normal speed (0.3) vs Stable near 200Â° (0.05)
                            let dist = Math.abs(liveAlpha - ROOM_60_ANGLE);
                            if (dist > 180) dist = 360 - dist;
                            let lerpFactor = (dist < 30) ? 0.05 : 0.3;

                            smoothedAlpha += diff * lerpFactor;
                        }

                        const finalHeading = Math.round((smoothedAlpha + 360) % 360);
                        magDisplay.innerText = finalHeading;

                        // Update rotating needle
                        if (needle) needle.style.transform = `rotate(${finalHeading}deg)`;

                        // 3. SECURE CALCULATION
                        let checkDiff = Math.abs(finalHeading - ROOM_60_ANGLE);
                        if (checkDiff > 180) checkDiff = 360 - checkDiff;

                        if (checkDiff <= ANGLE_TOLERANCE) {
                            floorVerified = true;
                            magDisplay.parentElement.className = "text-brandGreen font-bold";
                        } else {
                            floorVerified = false;
                            magDisplay.parentElement.className = "text-white";
                        }
                    } else {
                       
                        magDisplay.innerText = "LAPTOP";
                        if (pingArea) pingArea.classList.remove('hidden');
                        floorVerified = true; // Laptops bypass compass
                    }
                    if (typeof updateLogic === "function") updateLogic();
                });
            }
        }
        // Start compass engine
        checkPhysicalFloor();
        async function runPingFallback() {
            const start = Date.now();
            const pingDisplay = document.getElementById('debug-ping');
            try {
                // Uses a Google URL to bypass CORS and Laptop security blocks
                await fetch('https://connectivitycheck.gstatic.com/generate_204', {
                    mode: 'no-cors',
                    cache: 'no-store'
                });
                const latency = Date.now() - start;
                if (pingDisplay) pingDisplay.innerText = latency;
                return latency < 150;
            } catch (e) {
                if (pingDisplay) pingDisplay.innerText = "ERR";
                return false;
            }
        }

        // --- THE PING TRIGGER ---
        setInterval(async () => {
            const isFast = await runPingFallback();
            // If it's a laptop, let the Ping result control the floor lock
            if (document.getElementById('debug-mag').innerText === "LAPTOP") {
                floorVerified = isFast;
                if (typeof updateLogic === "function") updateLogic();
            }
        }, 3000);
        setInterval(checkPhysicalFloor, 3000);

        const PERMANENT_KEY = "GECWC2026";

        function checkQRVerification() {
            const urlParams = new URLSearchParams(window.location.search);
            const scannedKey = urlParams.get('vault');

            if (scannedKey === PERMANENT_KEY) {

                localStorage.setItem('qr_verified_at', Date.now());

                window.history.replaceState({}, document.title, window.location.pathname);
                return true;
            }

            // Check if they scanned recently
            const lastScan = localStorage.getItem('qr_verified_at');
            if (lastScan && (Date.now() - lastScan < 300000)) {
                return true;
            }
            return false;
        }
        let userPos = { lat: 0, lon: 0 };
        let wasInRange = false;
        let hapticsPrimed = false;
        let allNotices = [];
        let securityDisplayMode = "GPS"; // Switch for alternating messages
        let lastLockMessage = "";


        async function fetchAdminNotice() {
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "getNotice" })
                });
                const data = await res.json();
                const notices = data.notices || [];

                if (notices.length > 0) {
                    // 1. Get ONLY the absolute latest notice
                    const latest = notices[notices.length - 1];

                    // Create a unique ID based on message text so we know if they've seen THIS specific one
                    const noticeId = btoa(latest.msg.substring(0, 15)).replace(/=/g, "");

                    // 2. Check LocalStorage
                    if (localStorage.getItem('dismissed_' + noticeId)) {
                        console.log("Latest notice already dismissed by user.");
                        // Populate history modal even if main card is hidden
                        renderHistoryModal(notices);
                        return;
                    }

                    const gridContainer = document.getElementById('noticeGrid');
                    const gridItems = document.getElementById('gridItems');

                    gridContainer.classList.remove('hidden');
                    gridItems.innerHTML = `
                <div id="active-notice-card" class="relative bg-white dark:bg-darkSurface border-2 border-brandBlue/30 p-5 rounded-[2rem] shadow-2xl animate-slide-up z-[60]">
                    <button id="close-notice-btn" 
                            class="absolute top-3 right-3 w-9 h-9 flex items-center justify-center rounded-full bg-slate-100 dark:bg-zinc-800 text-slate-500 hover:text-brandRed transition-all active:scale-90 z-[70]">
                        <i class="fas fa-times text-lg"></i>
                    </button>

                    <div class="flex items-center gap-3 mb-2 pr-10">
                        <div class="w-10 h-10 rounded-2xl bg-brandBlue/10 flex items-center justify-center text-brandBlue">
                            <i class="fas fa-${latest.icon || 'bell'} text-lg"></i>
                        </div>
                        <span class="text-[10px] font-black uppercase tracking-widest text-brandBlue">Important Update</span>
                    </div>

                    <p class="text-sm font-bold text-slate-900 dark:text-white leading-relaxed pr-2">${latest.msg}</p>
                    
                    ${latest.link !== "#" ? `
                        <a href="${latest.link}" target="_blank" class="mt-3 inline-flex items-center gap-2 text-[11px] font-black text-brandBlue uppercase tracking-tighter hover:gap-3 transition-all">
                            View Attachment <i class="fas fa-arrow-right"></i>
                        </a>
                    ` : ''}
                </div>
            `;

                    // 3. ATTACH CLICK EVENT MANUALLY (More reliable than onclick attribute)
                    document.getElementById('close-notice-btn').addEventListener('click', () => {
                        const card = document.getElementById('active-notice-card');
                        card.style.transform = "translateY(-20px)";
                        card.style.opacity = "0";
                        card.style.transition = "0.3s ease";

                        localStorage.setItem('dismissed_' + noticeId, 'true');

                        setTimeout(() => {
                            gridContainer.classList.add('hidden');
                        }, 300);
                    });

                    renderHistoryModal(notices);
                    document.getElementById('notif-badge')?.classList.remove('hidden');
                }
            } catch (err) { console.warn("Notice Sync Error"); }
        }
        // Fixed Dismiss Function
        function dismissNotice(noticeId) {
            const gridContainer = document.getElementById('noticeGrid');

            // Apply exit animation
            gridContainer.style.transition = "all 0.4s ease";
            gridContainer.style.opacity = "0";
            gridContainer.style.transform = "translateY(-20px) scale(0.95)";

            // Save to permanent memory
            localStorage.setItem('hide_notice_' + noticeId, 'true');

            // Remove from view
            setTimeout(() => {
                gridContainer.classList.add('hidden');
            }, 400);
        }

        // Updated Dismiss function to save preference permanently
        function dismissNotice(noticeId) {
            const gridContainer = document.getElementById('noticeGrid');
            gridContainer.style.opacity = "0";
            gridContainer.style.transform = "translateY(-10px)";

            setTimeout(() => {
                gridContainer.classList.add('hidden');
                // Save to localStorage so it never shows again on the main screen
                localStorage.setItem('seen_notice_' + noticeId, 'true');
            }, 400);
        }

        function dismissNotice(cardId, storageKey) {
            const card = document.getElementById(cardId);
            // Animation for dismissal
            card.style.transform = "scale(0.9) translateY(-10px)";
            card.style.opacity = "0";

            setTimeout(() => {
                card.remove();
                sessionStorage.setItem('dismissed_' + storageKey, 'true');

                // If no cards left, hide the grid container
                const gridItems = document.getElementById('gridItems');
                if (gridItems.children.length === 0) {
                    document.getElementById('noticeGrid').classList.add('hidden');
                }
            }, 3000);
        }

        function renderHistoryModal(notices) {
            const list = document.getElementById('historyList');
            if (!list) return;
            list.innerHTML = '';

            // Show notices in reverse order (newest on top) inside the history modal
            [...notices].reverse().forEach(n => {
                const item = document.createElement('div');
                item.className = "p-4 rounded-2xl bg-slate-50 dark:bg-zinc-900 border border-slate-100 dark:border-zinc-800 flex items-start gap-4 mb-2";
                item.innerHTML = `
            <div class="mt-1 text-brandBlue"><i class="fas fa-${n.icon}"></i></div>
            <div>
                <p class="text-sm font-bold text-slate-900 dark:text-white">${n.msg}</p>
                ${n.link !== "#" ? `<a href="${n.link}" target="_blank" class="text-[10px] text-brandBlue font-bold uppercase mt-1 inline-block">View Link <i class="fas fa-external-link-alt ml-1"></i></a>` : ''}
            </div>`;
                list.appendChild(item);
            });
        }

        // Modal Control Functions
        function openHistory(e) {
            if (e) e.preventDefault();
            document.getElementById('historyModal').classList.remove('hidden');
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.add('hidden');
        }

        function openHistory(e) { if (e) e.preventDefault(); document.getElementById('historyModal').classList.remove('hidden'); }
        function closeHistory() { document.getElementById('historyModal').classList.add('hidden'); }

        function showGPSStatus() {
            const statusText = document.getElementById('gps-text').innerText;
            const isError = statusText.includes("ERROR") || statusText.includes("IDLE");

            showNotify(`GPS Status: ${statusText}`, isError ? 'error' : 'success');
            if ("vibrate" in navigator) navigator.vibrate(30);
        }


        function showGPSStatus() {
            const statusText = document.getElementById('gps-text').innerText;
            const isError = statusText.includes("ERROR") || statusText.includes("IDLE");
            showNotify(`GPS Status: ${statusText}`, isError ? 'error' : 'success');
            if ("vibrate" in navigator) navigator.vibrate(20);
        }

        // Load logs from phone memory and display them
        function renderLocalLogs() {
            const list = document.getElementById('localLogsList');
            const noLogsMsg = document.getElementById('noLogsMsg');
            const logs = JSON.parse(localStorage.getItem('my_attendance_history') || "[]");

            if (logs.length === 0) {
                noLogsMsg.classList.remove('hidden');
                return;
            }

            noLogsMsg.classList.add('hidden');
            list.querySelectorAll('.log-card').forEach(el => el.remove());

            logs.slice(-3).reverse().forEach((log, index) => {
                const card = document.createElement('div');
                card.className = "log-card p-5 rounded-3xl bg-slate-50 dark:bg-zinc-900/50 border border-slate-100 dark:border-zinc-800 animate-slide-up relative group";
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="text-[9px] font-black text-brandGreen bg-brandGreen/10 px-2 py-0.5 rounded-full uppercase">Verified</span>
                        <span class="text-[10px] text-slate-400 font-medium">${log.time}</span>
                    </div>
                    <p class="text-sm font-bold text-slate-900 dark:text-white truncate">${log.name}</p>
                    <p class="text-[10px] text-slate-500 mb-4 uppercase tracking-wider">Roll: ${log.roll} â€¢ Room: ${log.room}</p>
                    
                    <button onclick="shareReceipt('${log.name}', '${log.roll}', '${log.time}', '${log.room}')" 
                            class="w-full py-2 bg-brandBlue/10 hover:bg-brandBlue text-brandBlue hover:text-white text-[10px] font-bold rounded-xl transition-all uppercase tracking-widest flex items-center justify-center gap-2">
                        <i class="fas fa-share-nodes"></i> Share Receipt
                    </button>
                `;
                list.appendChild(card);
            });
        }

        // The Sharing Function
        async function shareReceipt(name, roll, time, room) {
            const shareData = {
                title: 'Attendance Receipt',
                text: `âœ… *Attendance Verified*\n\nðŸ‘¤ Name: ${name}\nðŸ†” Roll: ${roll}\nðŸ“ Room: ${room}\nâ° Time: ${time}\n\n_Generated by GEC WC Smart Portal_`,
            };

            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // Fallback: Copy to clipboard if sharing is not supported
                    await navigator.clipboard.writeText(shareData.text);
                    showNotify("Receipt copied to clipboard!", "success");
                }
            } catch (err) {
                console.log("Sharing failed", err);
            }
        }

        // Add a new log to memory
        function saveLogLocally(name, roll, room) {
            const logs = JSON.parse(localStorage.getItem('my_attendance_history') || "[]");
            const newLog = {
                name: name,
                roll: roll,
                room: room,
                time: new Date().toLocaleString([], { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' })
            };
            logs.push(newLog);
            localStorage.setItem('my_attendance_history', JSON.stringify(logs));
            renderLocalLogs();
        }


        function clearMyHistory() {
            document.getElementById('clearConfirmModal').classList.remove('hidden');
            if ("vibrate" in navigator) navigator.vibrate(50);
        }


        function closeClearModal() {
            document.getElementById('clearConfirmModal').classList.add('hidden');
        }


        function executeClearHistory() {
            localStorage.removeItem('my_attendance_history');
            closeClearModal();
            renderLocalLogs(); // Refreshes the UI to show "No logs"
            showNotify("History cleared successfully", "success");
            if ("vibrate" in navigator) navigator.vibrate([50, 30, 50]);
        }


        renderLocalLogs();

        fetchAdminNotice();
        //  TIME TOKEN GENERATOR ---
        function generateToken() {
            const now = new Date();
            const timeStr = now.getHours().toString() + now.getMinutes().toString();
            // Salt must match backend salt exactly
            return btoa(timeStr + "GECWC_PRIVATE_SALT").substring(0, 8);
        }

        function primeHaptics() {
            if (!hapticsPrimed && "vibrate" in navigator) {
                navigator.vibrate(1);
                hapticsPrimed = true;
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                icon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark');
                icon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'dark');
            }
        }

        if (localStorage.getItem('theme') === 'light') {
            document.documentElement.classList.remove('dark');
            document.getElementById('theme-icon').className = 'fas fa-sun';
        }

        function showNotify(msg, type = 'info') {
            const n = document.getElementById('notification');
            const c = document.getElementById('notifyContent');
            n.classList.remove('opacity-0', '-translate-y-2', 'pointer-events-none');
            n.classList.add('opacity-100', 'translate-y-0');

            let bg = 'bg-white/90 dark:bg-zinc-900/90 border-slate-200 dark:border-zinc-700 text-zinc-900 dark:text-white';
            if (type === 'success') bg = 'bg-brandGreen/20 border-brandGreen/50 text-brandGreen';
            if (type === 'error') bg = 'bg-brandRed/20 border-brandRed/50 text-brandRed';
            if (type === 'info') bg = 'bg-brandBlue/20 border-brandBlue/50 text-brandBlue';

            c.className = `px-6 py-4 rounded-2xl shadow-2xl font-bold text-sm border backdrop-blur-md ${bg}`;
            c.innerText = msg;

            setTimeout(() => {
                n.classList.add('opacity-0', '-translate-y-2', 'pointer-events-none');
                n.classList.remove('opacity-100', 'translate-y-0');
            }, 3500);
        }

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([CLASS_COORDS.lat, CLASS_COORDS.lng], 19);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        L.circle([CLASS_COORDS.lat, CLASS_COORDS.lng], {
            color: '#2563eb', radius: MAX_DIST, weight: 1, fillOpacity: 0.1
        }).addTo(map);

        let userMarker;

        navigator.geolocation.watchPosition((pos) => {
            userPos.lat = pos.coords.latitude;
            userPos.lon = pos.coords.longitude;

            // 1. GPS INDICATORS
            const dot = document.getElementById('gps-dot');
            const ping = document.getElementById('gps-ping');
            const txt = document.getElementById('gps-text');
            dot.className = "relative inline-flex rounded-full h-2.5 w-2.5 bg-brandGreen";
            ping.classList.remove('hidden');
            txt.innerText = "GPS ACTIVE";

            // 2. MAP & MARKER
            if (!userMarker) {
                userMarker = L.circleMarker([userPos.lat, userPos.lon], {
                    radius: 9, color: '#2563eb', fillColor: '#2563eb', fillOpacity: 1
                }).addTo(map);
                map.setView([userPos.lat, userPos.lon], 19);
            } else {
                userMarker.setLatLng([userPos.lat, userPos.lon]);
            }


            function startAutomaticGPS() {
                const options = {
                    enableHighAccuracy: true,
                    maximumAge: 0,        // Force fresh data (don't use cache)
                    timeout: Infinity     // Don't give up if the satellite is slow
                };


                navigator.geolocation.watchPosition((pos) => {
                    userPos.lat = pos.coords.latitude;
                    userPos.lon = pos.coords.longitude;

                    // Update your UI here
                    document.getElementById('gps-text').innerText = "GPS ACTIVE";
                    document.getElementById('gps-dot').className = "relative inline-flex rounded-full h-2.5 w-2.5 bg-brandGreen";

                    // Call your logic to check distance
                    updateLogic();

                }, (err) => {
                    console.warn("GPS Waiting...");
                    if (err.code !== 3) {
                        document.getElementById('gps-text').innerText = "GPS ERROR: " + err.message;
                    }
                }, options);
            }


            startAutomaticGPS();
            const dist = calculateDistance(userPos.lat, userPos.lon, CLASS_COORDS.lat, CLASS_COORDS.lng);
            const isScanned = checkQRVerification();

            // 4. UPDATE GAUGE UI
            document.getElementById('liveDist').innerHTML = `${Math.round(dist)}<span class="text-xl font-medium text-slate-400 dark:text-zinc-600 ml-1">m</span>`;
            const percentage = Math.max(0, 100 - (dist * (100 / MAX_DIST)));
            document.getElementById('distBar').style.width = `${percentage}%`;

            const bar = document.getElementById('distBar');
            const tag = document.getElementById('range-tag');
            const lockMsg = document.getElementById('lockMessage');
            const entryForm = document.getElementById('entryForm');



            if (dist > MAX_DIST) {
                // LAYER 1: GPS FAIL (Red)
                bar.className = "dist-gauge h-full bg-brandRed";
                tag.innerText = "ACCESS DENIED";
                tag.className = "text-[10px] font-bold px-2 py-0.5 rounded-md bg-brandRed/10 text-brandRed border border-brandRed/20";

                entryForm.classList.add('hidden');
                lockMsg.classList.remove('hidden');
                updateLockUI("OUT OF RANGE", `Move closer to Room 60 (${Math.round(dist)}m)`, "fa-location-dot", "text-brandRed");
            }
            else if (!isScanned) {
                // LAYER 2: QR FAIL (Blue)
                bar.className = "dist-gauge h-full bg-brandBlue";
                tag.innerText = "SCAN REQUIRED";
                tag.className = "text-[10px] font-bold px-2 py-0.5 rounded-md bg-brandBlue/10 text-brandBlue border border-brandBlue/20";

                entryForm.classList.add('hidden');
                lockMsg.classList.remove('hidden');
                // Your specific request: Blue QR icon
                updateLockUI("SCAN QR CODE", "Please Scan the Qr code..", "fa-qrcode", "text-brandBlue", true);
            }
            else if (!floorVerified) {
                // Current state: Orange/Yellow warning
                bar.className = "dist-gauge h-full bg-yellow-500";
                tag.innerText = "FLOOR SECURITY";
                tag.className = "text-[10px] font-bold px-2 py-0.5 rounded-md bg-yellow-500/10 text-yellow-500 border border-yellow-500/20";

                entryForm.classList.add('hidden');
                lockMsg.classList.remove('hidden');

                // Show the specific Layer icon for floor security
                updateLockUI("VERIFYING FLOOR", "Hold phone steady infront of QR", "fa-layer-group", "text-yellow-500", false, true);
            }
            else {
                // ALL PASS (Green)
                bar.className = "dist-gauge h-full bg-brandGreen";
                tag.innerText = "IN CLASS VERIFIED";
                tag.className = "text-[10px] font-bold px-2 py-0.5 rounded-md bg-brandGreen/10 text-brandGreen border border-brandGreen/20";

                lockMsg.classList.add('hidden');
                entryForm.classList.remove('hidden');
            }
            function updateLockUI(title, sub, icon, colorClass, pulse = false, bounce = false) {
                const lockMsg = document.getElementById('lockMessage');
                const newStateId = `${title}-${colorClass}`;

                if (currentLockState === newStateId) return;
                currentLockState = newStateId;

                let actionButton = "";
                if (title === "SCAN QR CODE") {
                    actionButton = `
            <button id="google-scan-btn" 
                    class="mt-6 px-8 py-4 bg-white dark:bg-zinc-950 text-slate-900 dark:text-white rounded-[2rem] font-black text-xs uppercase tracking-widest shadow-xl border-2 border-brandBlue/10 hover:border-brandBlue/40 active:scale-95 transition-all flex items-center gap-3 group relative z-[1000]">
                <div class="w-8 h-8 flex items-center justify-center bg-slate-50 dark:bg-zinc-900 rounded-full group-hover:scale-110 transition-transform">
                   <i class="fab fa-google text-brandBlue"></i>
                </div>
                Open AR Lens
            </button>
            <p class="text-[8px] font-black text-slate-400 mt-4 uppercase tracking-[0.2em] animate-pulse">CLICK ON UPPER BUTTON AND SACN</p>
        `;
                }

                lockMsg.innerHTML = `
        <div class="flex flex-col items-center animate-slide-up w-full">
            <div class="w-20 h-20 bg-slate-50 dark:bg-zinc-900 rounded-full flex items-center justify-center mb-4 border border-slate-200 dark:border-zinc-800 shadow-inner">
                <i class="fas ${icon} ${colorClass} text-4xl ${pulse ? 'animate-pulse' : ''} ${bounce ? 'animate-bounce' : ''}"></i>
            </div>
            <div class="text-center">
                <p class="${colorClass} font-black text-xl uppercase tracking-tighter">${title}</p>
                <p class="text-slate-500 dark:text-zinc-400 text-sm mt-1">${sub}</p>
            </div>
            ${actionButton}
        </div>`;

                const scanBtn = document.getElementById('google-scan-btn');
                if (scanBtn) {
                    // Clear old listeners and add the new one
                    scanBtn.replaceWith(scanBtn.cloneNode(true));
                    document.getElementById('google-scan-btn').addEventListener('click', (e) => {
                        e.preventDefault();
                        launchIntegratedGoogle();
                    });
                }
            }
        }, (err) => {
            console.warn("GPS ERROR");
        }, { enableHighAccuracy: true });

        document.getElementById('roll').addEventListener('blur', async (e) => {
            const roll = e.target.value.trim();
            if (!roll) return;

            //  Local Memory 
            const savedData = JSON.parse(localStorage.getItem('student_' + roll));
            if (savedData) {
                document.getElementById('name').value = savedData.name || "";
                document.getElementById('reg').value = savedData.reg || "";
                document.getElementById('mobile').value = savedData.mobile || "";
                document.getElementById('email').value = savedData.email || "";
            }

            // 2. Network verification 
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "lookup", type: 'classroom', roll: roll })
                });
                const data = await res.json();
                if (data.user && data.user.found) {
                    document.getElementById('name').value = data.user.name || "";
                    document.getElementById('reg').value = data.user.reg || "";
                    document.getElementById('mobile').value = data.user.mobile || "";
                    document.getElementById('email').value = data.user.email || "";
                    showNotify(`Verified Details: ${data.user.name}`, "success");
                }
            } catch (err) { console.warn("Cloud lookup offline"); }
        });


        document.getElementById('entryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = `<span>VERIFYING IDENTITY...</span> <i class="fas fa-fingerprint animate-pulse ml-2"></i>`;

            const bioSig = await getBiometricSignature();
            if (!bioSig || bioSig === "NOT_SUPPORTED") {
                showNotify(bioSig === "NOT_SUPPORTED" ? "Biometrics not supported" : "Verification Failed", "error");
                btn.disabled = false; btn.innerHTML = "MARK ATTENDANCE";
                return;
            }

            btn.innerHTML = `<span>CHECKING RANGE...</span> <i class="fas fa-circle-notch animate-spin ml-2"></i>`;

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const payload = {
                    action: "submit",
                    dynamicPin: document.getElementById('userPinInput').value,
                    token: generateToken(),
                    roll: document.getElementById('roll').value,
                    name: document.getElementById('name').value,
                    reg: document.getElementById('reg').value,
                    mobile: document.getElementById('mobile').value,
                    email: document.getElementById('email').value,
                    lat: pos.coords.latitude,
                    lon: pos.coords.longitude,
                    deviceId: getDeviceId(),
                    bioSignature: bioSig
                };

                try {
                    const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                    const result = await res.json();
                    if (result.success) {
                        showNotify("Attendance Marked!", "success");
                        saveLogLocally(payload.name, payload.roll, "60");
                        setTimeout(() => location.reload(), 2500);
                    } else {
                        showNotify(result.error, "error");
                        btn.disabled = false; btn.innerHTML = "MARK ATTENDANCE";
                    }
                } catch (err) {
                    showNotify("Network Error", "error");
                    btn.disabled = false;
                }
            }, (err) => {
                showNotify("Location Required", "error");
                btn.disabled = false;
            }, { enableHighAccuracy: true });
        });


        async function getBiometricSignature() {
            if (!window.PublicKeyCredential) return "NOT_SUPPORTED";

            const rollNo = document.getElementById('roll').value.trim();
            const regNo = document.getElementById('reg').value.trim();

            // Create a unique local key for this specific student identity
            const identityKey = `auth_${rollNo}_${regNo}`;

            const challenge = new Uint8Array(32);
            window.crypto.getRandomValues(challenge);
            const savedKeyId = localStorage.getItem(identityKey);

            try {
                if (!savedKeyId) {
                    // RE-REGISTER/NEW REGISTER
                    const cred = await navigator.credentials.create({
                        publicKey: {
                            challenge: challenge,
                            rp: { name: "GECWC Attendance" },
                            user: {
                                id: Uint8Array.from(regNo, c => c.charCodeAt(0)),
                                name: `${rollNo}-${regNo}`,
                                displayName: `Student ${rollNo}`
                            },
                            pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                            authenticatorSelection: { userVerification: "required" },
                            timeout: 60000
                        }
                    });

                    const publicKeyBuffer = cred.response.getPublicKey();
                    const hashBuffer = await window.crypto.subtle.digest('SHA-256', publicKeyBuffer);
                    const hashHex = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');

                    const base64Id = btoa(String.fromCharCode(...new Uint8Array(cred.rawId)));
                    localStorage.setItem(identityKey, base64Id);

                    return hashHex;
                } else {
                    // VERIFY
                    await navigator.credentials.get({
                        publicKey: {
                            challenge: challenge,
                            allowCredentials: [{ id: Uint8Array.from(atob(savedKeyId), c => c.charCodeAt(0)), type: 'public-key' }],
                            userVerification: "required"
                        }
                    });
                    return "VERIFIED_EXISTING";
                }
            } catch (e) {
                console.error("Biometric Error:", e);
                return null;
            }
        }


        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }


        function getDeviceId() {
            let id = localStorage.getItem('device_fingerprint');
            if (!id) {
                // Create a unique signature for this physical phone
                id = 'DEV-' + Math.random().toString(36).substr(2, 9).toUpperCase() + '-' + Date.now();
                localStorage.setItem('device_fingerprint', id);
            }
            return id;
        }

        function generate5MinPIN() {
            const now = new Date();
            const day = now.getDate();
            const hour = now.getHours();
            const minuteBlock = Math.floor(now.getMinutes() / 5);


            const pin = Math.abs(((day * 127) + (hour * 13) + (minuteBlock * 57) + 1234) % 10000);
            return pin.toString().padStart(4, '0');
        }

        // 2. Update UI and Timer
        function updatePINSystem() {
            const currentPin = generate5MinPIN();
            const display = document.getElementById('pinDisplay');
            const timerText = document.getElementById('pin-timer');

            display.innerText = currentPin;

            const now = new Date();
            const secToNextBlock = 300 - ((now.getMinutes() % 5) * 60 + now.getSeconds());
            const mins = Math.floor(secToNextBlock / 60);
            const secs = secToNextBlock % 60;
            timerText.innerText = `Refreshes in: ${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }


        setInterval(updatePINSystem, 1000);
        updatePINSystem();

        // Force the GPS logic to re-check status every 2 seconds
        setInterval(() => {
            const dLock = document.getElementById('debug-lock');
            if (floorVerified) {
                dLock.innerText = "UNLOCKED";
                dLock.className = "text-brandGreen font-bold";
            } else {
                dLock.innerText = "LOCKED";
                dLock.className = "text-brandRed font-bold";
            }
        }, 1000);

        function validatePinInput() {
            const btn = document.getElementById('submitBtn');
            const icon = document.getElementById('btn-lock-icon');
            const input = document.getElementById('userPinInput');
            const currentPin = generate5MinPIN();

            if (input.value === currentPin) {
                // UNLOCK STATE
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-brandBlue');
                btn.classList.add('bg-brandGreen', 'hover:bg-green-600');
                icon.className = "fas fa-check-circle";
                input.classList.remove('animate-shake', 'border-brandRed');
                input.classList.add('border-brandGreen');
            } else {
                // LOCK STATE
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.classList.remove('bg-brandGreen', 'hover:bg-green-600');
                btn.classList.add('bg-brandBlue');
                icon.className = "fas fa-lock";
                input.classList.remove('border-brandGreen');

                // Trigger Shake & Vibrate if 4 wrong digits are typed
                if (input.value.length === 4) {
                    input.classList.add('animate-shake');
                    if ("vibrate" in navigator) navigator.vibrate([100, 50, 100]);
                    setTimeout(() => input.classList.remove('animate-shake'), 400);
                }
            }
        }

        function updateLogic() {
            const btn = document.getElementById('submitBtn');
            const lockIcon = document.getElementById('btn-lock-icon');
            const isScanned = checkQRVerification();

            // Check if we are in range based on device type
            const isLaptop = document.getElementById('debug-mag').innerText === "LAPTOP";
            const dist = calculateDistance(userPos.lat, userPos.lon, CLASS_COORDS.lat, CLASS_COORDS.lng);
            const inRange = dist <= (isLaptop ? 1000 : MAX_DIST);


            if (inRange && isScanned && floorVerified) {
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.classList.add('opacity-100');
                lockIcon.className = "fas fa-unlock-alt";
            } else {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                lockIcon.className = "fas fa-lock";
            }
        }
        // --- THE PING TRIGGER ---
        setInterval(async () => {
            // This runs the ping and updates the text automatically
            const isFast = await runPingFallback();

            // Optional: If you want the Ping check to help unlock the form on Laptop
            if (document.getElementById('debug-mag').innerText === "LAPTOP") {
                floorVerified = isFast;
                if (typeof updateLogic === "function") updateLogic();
            }
        }, 3000);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('App ready: Service Worker Registered'))
                    .catch(err => console.log('Service Worker failed', err));
            });
        }

        async function updateLiveTimetable() {
            const ongoingSection = document.getElementById('ongoing-section');
            const timelineSection = document.getElementById('timeline-section');
            const roadmapList = document.getElementById('roadmap-list');

            try {
                const response = await fetch(SCRIPT_URL + "?v=" + Date.now(), { method: 'POST', body: JSON.stringify({ action: "getTimetable" }) });
                const data = await response.json();

                const now = new Date();
                const ist = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
                const currentMins = (ist.getHours() * 60) + ist.getMinutes();
                const currentDay = ist.toLocaleString('en-us', { weekday: 'long' }).toUpperCase();

                const toMins = (t) => { if (!t.includes(':')) return 0; const [h, m] = t.split(':').map(Number); return (h * 60) + m; };

                const todaysClasses = data.timetable.filter(c => c.day === currentDay)
                    .map(c => ({ ...c, sM: toMins(c.startRaw), eM: toMins(c.endRaw) }))
                    .sort((a, b) => a.sM - b.sM);

                if (todaysClasses.length === 0) return;

                // --- TOP CARD REFRESH ---
                let active = todaysClasses.find(c => currentMins >= c.sM && currentMins < c.eM);
                let next = todaysClasses.find(c => c.sM > currentMins);
                let displayClass = active || next;

                if (displayClass) {
                    ongoingSection.classList.remove('hidden');
                    document.getElementById('active-subject').innerText = displayClass.subject;
                    document.getElementById('active-faculty').innerText = displayClass.faculty;
                    document.getElementById('active-teacher-img').src = displayClass.image || "image/logo.png";
                    document.getElementById('active-start-label').innerText = displayClass.startRaw;
                    document.getElementById('active-end-label').innerText = displayClass.endRaw;

                    const badge = document.getElementById('active-badge');
                    const statusTxt = document.getElementById('status-text');
                    const tagBox = document.getElementById('status-tag-container');
                    const countdown = document.getElementById('active-countdown');
                    const activeBar = document.getElementById('active-class-progress');
                    const pingRing = document.getElementById('ping-ring');
                    const pingDot = document.getElementById('ping-dot');

                    if (active) {
                        badge.innerText = "LIVE";
                        badge.className = "absolute -bottom-1 -right-1 bg-brandGreen text-white text-[8px] font-black px-3 py-1 rounded-xl border-2 border-white dark:border-zinc-950 animate-bounce";
                        statusTxt.innerText = "Currently Teaching";
                        statusTxt.className = "text-[9px] font-black uppercase text-brandGreen";
                        tagBox.className = "inline-flex items-center gap-2 px-3 py-1 rounded-full mb-2 bg-brandGreen/10 border-2 border-brandGreen/40";
                        pingRing.className = "absolute inline-flex h-full w-full rounded-full opacity-75 animate-ping bg-brandGreen";
                        pingDot.className = "relative inline-flex rounded-full h-2 w-2 bg-brandGreen";

                        const perc = Math.min(100, ((currentMins - active.sM) / (active.eM - active.sM)) * 100);
                        activeBar.style.width = `${perc}%`;
                        activeBar.className = "h-full rounded-full bg-brandGreen shadow-lg";
                        countdown.innerText = `${active.eM - currentMins}m REMAINING`;
                    } else {
                        badge.innerText = "NEXT";
                        badge.className = "absolute -bottom-1 -right-1 bg-brandBlue text-white text-[8px] font-black px-3 py-1 rounded-xl border-2 border-white dark:border-zinc-950";
                        statusTxt.innerText = "Up Next in Schedule";
                        statusTxt.className = "text-[9px] font-black uppercase text-brandBlue";
                        tagBox.className = "inline-flex items-center gap-2 px-3 py-1 rounded-full mb-2 bg-brandBlue/10 border-2 border-brandBlue/40";
                        pingRing.className = "hidden";
                        pingDot.className = "relative inline-flex rounded-full h-2 w-2 bg-brandBlue";

                        activeBar.style.width = `0%`;
                        countdown.innerText = `STARTS IN ${displayClass.sM - currentMins}m`;
                    }
                }

                // --- COMPACT ROADMAP (STRICT BORDERS & NO DIMMING) ---
                timelineSection.classList.remove('hidden');
                roadmapList.innerHTML = '';
                let completedSteps = 0;

                todaysClasses.forEach((item) => {
                    let state = "Upcoming", dot = "bg-zinc-800", cardBorder = "border-slate-200 dark:border-white/10", icon = "fa-clock", tagStyle = "bg-zinc-800 text-zinc-500", dotBorder = "border-white dark:border-zinc-950";

                    if (currentMins >= item.eM) {
                        state = "Done"; dot = "bg-brandGreen"; cardBorder = "border-brandGreen/40 shadow-lg shadow-brandGreen/5"; icon = "fa-check-double"; tagStyle = "bg-brandGreen text-white"; completedSteps++;
                    } else if (currentMins >= item.sM && currentMins < item.eM) {
                        state = "Ongoing"; dot = "bg-brandBlue ring-4 ring-brandBlue/20 scale-105 shadow-xl"; cardBorder = "border-brandBlue shadow-xl shadow-brandBlue/5"; icon = "fa-satellite-dish"; tagStyle = "bg-brandBlue text-white"; completedSteps += 0.5;
                    } else {
                        // Keep upcoming orange/amber for high visibility
                        tagStyle = "bg-amber-500/10 text-amber-600 dark:text-amber-500 border border-amber-500/30";
                        icon = "fa-hourglass-start";
                    }

                    roadmapList.insertAdjacentHTML('beforeend', `
                <div class="relative flex items-start gap-4 pb-4 last:pb-2">
                    <div class="relative z-20 w-11 h-11 rounded-2xl flex items-center justify-center border-4 ${dotBorder} ${dot} transition-all shadow-lg text-white text-[10px]">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="flex-grow p-4 rounded-[2rem] border-2 bg-white dark:bg-zinc-900/40 ${cardBorder} transition-all">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">${item.startRaw} - ${item.endRaw}</span>
                            <span class="${tagStyle} text-[7px] font-black px-2 py-0.5 rounded-lg uppercase tracking-widest">${state}</span>
                        </div>
                        <h4 class="font-bold text-slate-900 dark:text-white text-sm leading-tight">${item.subject}</h4>
                        <div class="flex items-center gap-2 mt-3">
                            <img src="${item.image || 'image/logo.png'}" class="w-7 h-7 rounded-full object-cover border border-slate-200 dark:border-zinc-700">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-slate-600 dark:text-zinc-400 font-black uppercase truncate">${item.faculty}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `);
                });

                const perc = Math.min(100, Math.round((completedSteps / todaysClasses.length) * 100));
                document.getElementById('timeline-progress-bar').style.height = `${perc}%`;
                const pTxt = document.getElementById('day-progress-text');
                pTxt.innerText = `${perc}% COMPLETE`;
                pTxt.className = `px-4 py-2 rounded-2xl font-black text-[9px] uppercase border-2 shadow-sm ${perc === 100 ? 'bg-brandGreen/10 border-brandGreen text-brandGreen' : 'bg-brandBlue/10 border-brandBlue text-brandBlue'}`;

            } catch (e) { console.error("UI Update Failed"); }
        }
        // --- INITIALIZE ALL SYSTEMS ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Check for class immediately
            updateLiveTimetable();

            // 2. Start other background services
            fetchAdminNotice();
            renderLocalLogs();
            checkPhysicalFloor();

            // 3. Link the PIN input
            document.getElementById('userPinInput').addEventListener('input', validatePinInput);
        });

        // Refresh timetable every 60 seconds
        setInterval(updateLiveTimetable, 60000);
        function launchGoogleLens() {
            if ("vibrate" in navigator) navigator.vibrate(40);

            const isAndroid = /Android/i.test(navigator.userAgent);

            if (isAndroid) {
                // This specific intent opens the Google App's built-in visual search (Lens mode)
                // It does NOT require the separate "Google Lens" app.
                const googleAppLensIntent = "intent://google.com/searchbyimage/upload#Intent;scheme=https;package=com.google.android.googlequicksearchbox;action=android.intent.action.SEND;end";

                try {
                    window.location.href = googleAppLensIntent;
                } catch (e) {
                    // If the intent fails, we open the Google Lens web-view directly
                    window.location.href = "https://www.google.com/searchbyimage/upload";
                }
            } else {
                // iOS users can simply use their native camera which has "Visual Look Up"
                showNotify("Please use your native camera to scan the QR", "info");
            }
        }

        function launchIntegratedGoogle() {
            if ("vibrate" in navigator) navigator.vibrate([40, 40]);

            const isAndroid = /Android/i.test(navigator.userAgent);

            if (isAndroid) {
                // This is the direct URI for the Google App's AR Lens Activity
                const directLensIntent = "googlelens://v1/scan";

                // This is the backup Android Intent if the URI scheme is blocked
                const intentURL = "intent://scan/#Intent;scheme=googlelens;package=com.google.ar.lens;end";

                // Try the most direct route first
                window.location.href = directLensIntent;

                // If nothing happens in 800ms, try the standard intent
                setTimeout(() => {
                    if (document.hasFocus()) {
                        window.location.href = intentURL;
                    }
                }, 800);

                // Final Fallback: Google Search Upload Page
                setTimeout(() => {
                    if (document.hasFocus()) {
                        window.location.href = "https://www.google.com/searchbyimage/upload";
                    }
                }, 2000);
            } else {
                // iOS or Desktop
                window.location.href = "https://www.google.com/searchbyimage/upload";
            }
        }
    </script>

    <div id="historyModal"
        class="hidden fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-darkSurface w-full max-w-md rounded-[2.5rem] border border-slate-200 dark:border-darkBorder shadow-2xl overflow-hidden animate-slide-up">
            <div class="p-6 border-b border-slate-100 dark:border-zinc-800 flex justify-between items-center">
                <h3 class="font-black text-xl tracking-tight text-slate-900 dark:text-white">Notice History</h3>
                <button onclick="closeHistory()" class="text-slate-400 hover:text-brandRed transition-colors">
                    <i class="fas fa-times-circle text-2xl"></i>
                </button>
            </div>
            <div id="historyList" class="max-h-[60vh] overflow-y-auto p-4 space-y-3">
                <p class="text-center text-slate-400 py-10">No older notifications.</p>
            </div>
        </div>
    </div>
    <div id="clearConfirmModal"
        class="hidden fixed inset-0 z-[200] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div
            class="bg-white dark:bg-darkSurface w-full max-w-xs rounded-[2.5rem] border border-slate-200 dark:border-darkBorder shadow-2xl p-8 text-center animate-slide-up">
            <div
                class="w-16 h-16 bg-brandRed/10 text-brandRed rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-trash-alt text-2xl"></i>
            </div>
            <h3 class="font-black text-xl mb-2 text-slate-900 dark:text-white">Clear History?</h3>
            <p class="text-slate-500 dark:text-zinc-400 text-xs mb-8">This will delete your local logs permanently. This
                action cannot be undone.</p>

            <div class="flex flex-col gap-3">
                <button onclick="executeClearHistory()"
                    class="w-full bg-brandRed text-white py-4 rounded-2xl font-black text-sm shadow-lg shadow-brandRed/20 active:scale-95 transition-all">
                    YES, DELETE ALL
                </button>
                <button onclick="closeClearModal()"
                    class="w-full bg-slate-100 dark:bg-zinc-800 text-slate-500 dark:text-zinc-400 py-4 rounded-2xl font-black text-sm active:scale-95 transition-all">
                    CANCEL
                </button>
            </div>
        </div>
    </div>
    <div id="debug-box"
        class="fixed bottom-4 left-4 z-[500] bg-black/80 text-white p-3 rounded-2xl text-[10px] font-mono border border-white/20 backdrop-blur-md flex items-center gap-3">

        <div id="compass-needle" class="w-6 h-6 flex items-center justify-center transition-transform duration-100">
            <i class="fas fa-location-arrow text-brandBlue" style="transform: rotate(-45deg);"></i>
        </div>

        <div>
            <div>HEADING: <span id="debug-mag">--</span>Â°
                <span id="ping-area">| PING: <span id="debug-ping">--</span> ms</span>
            </div>
            <div>LOCK: <span id="debug-lock" class="text-brandRed">LOCKED</span></div>
        </div>
    </div>
</body>

</html>